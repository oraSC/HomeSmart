#include "font.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <strings.h>

#define CHINESE		1


typedef struct FonT{
	
	unsigned char str[4];
	unsigned char *array_16;
	unsigned char *array_32; 

}Font_t , *pFont_t;


static unsigned char Chinese[] = "车位";
static unsigned char English[] = "11234567890";

unsigned char  che_16x16[] 	= {
0x02,0x00,0x02,0x00,0x02,0x00,0x7F,0xFC,0x04,0x00,0x09,0x00,0x11,0x00,0x21,0x00,
0x3F,0xF8,0x01,0x00,0x01,0x00,0xFF,0xFE,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00};

unsigned char che_32x32[] 	= {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x06,0x00,0x00,
0x00,0x0E,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,0x1C,0x00,0x60,0x0F,0xFF,0xFF,0xF0,
0x00,0x18,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x31,0xC0,0x00,0x00,0x61,0x80,0x00,
0x00,0xC1,0x80,0x00,0x00,0xC1,0x80,0x00,0x01,0x81,0x80,0x00,0x03,0x81,0x80,0xC0,
0x07,0xFF,0xFF,0xE0,0x03,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,
0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x18,0x3F,0xFF,0xFF,0xFC,0x00,0x01,0x80,0x00,
0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,
0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00};

unsigned char wei_16x16[] 	= {
0x08,0x80,0x08,0x40,0x08,0x40,0x10,0x00,0x17,0xFC,0x30,0x00,0x30,0x08,0x52,0x08,
0x92,0x08,0x11,0x10,0x11,0x10,0x11,0x10,0x11,0x20,0x10,0x20,0x1F,0xFE,0x10,0x00};

unsigned char wei_32x32[]	= {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0xE0,0x40,0x00,
0x00,0xC0,0x30,0x00,0x00,0xC0,0x30,0x00,0x01,0x80,0x38,0x00,0x01,0x80,0x10,0x00,
0x01,0x00,0x00,0x30,0x03,0x3F,0xFF,0xF8,0x02,0x00,0x00,0x00,0x07,0x80,0x00,0x00,
0x07,0x00,0x00,0x80,0x0F,0x04,0x01,0xC0,0x0B,0x02,0x01,0xC0,0x1B,0x02,0x01,0x80,
0x13,0x03,0x01,0x80,0x23,0x03,0x01,0x00,0x43,0x01,0x83,0x00,0x03,0x01,0x83,0x00,
0x03,0x01,0x82,0x00,0x03,0x01,0x82,0x00,0x03,0x01,0x82,0x00,0x03,0x01,0x84,0x00,
0x03,0x00,0x04,0x00,0x03,0x00,0x04,0x00,0x03,0x00,0x08,0x00,0x03,0x00,0x08,0x18,
0x03,0x3F,0xFF,0xFC,0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

unsigned char _1_8x16[]	= {
0x00,0x00,0x00,0x08,0x38,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00};

unsigned char _1_16x32[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x01,0x80,
0x1F,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,
0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,
0x01,0x80,0x01,0x80,0x03,0xC0,0x1F,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};







Font_t 	FONTLIB[10];
int	LIB_SIZE;



unsigned char *search_font_array();
int Print();
int add_FONTLIB();

int main()
{
	
	//初始化
	bzero(&FONTLIB, sizeof(FONTLIB));
	LIB_SIZE = 0;

	add_FONTLIB("车", che_16x16, che_32x32);
	add_FONTLIB("位", wei_16x16, wei_32x32);
	add_FONTLIB("1", _1_8x16, _1_16x32);	

	
	pLcdInfo_t plcdinfo = (LcdInfo_t *)malloc(sizeof(LcdInfo_t));
	lcd_create("/dev/fb0", plcdinfo);

	print_string(plcdinfo, 500, 30, "车位1", 32);

	


}


//
int print_string(pLcdInfo_t plcdinfo, int x, int y, unsigned char *str, int size)
{
	
	//遍历字符串，匹配字符 UTF-8中文字符占用三个字节
	unsigned char *font_array = NULL;
	for(int i = 0; i < strlen(str); )
	{
		if(str[i] > 127)
		{
			unsigned char chinese[4] = {0};
			strncpy(chinese, str + i, 3);
			printf("%s\n", chinese);
			i = i + 3;
			
			//寻找字库数据
			font_array = search_font_array(chinese, size);
			Print(plcdinfo, x, y, font_array, size, size, 0x00FF0000);
			
			//位置右移
			x = x + size;
		}
		else 
		{
			unsigned char english[2] = {0};
			english[0] = str[i];
			printf("%c\n", english);
			i++;
		
			//寻找字库数据
			font_array = search_font_array(english, size);
			Print(plcdinfo, x, y, font_array, size / 2, size, 0x00FF0000);
	
			//位置右移
			x = x + size / 2;
		}

	}
	





}

int add_FONTLIB(unsigned char *str, unsigned char *array_16, unsigned char *array_32)
{
	strcpy(FONTLIB[LIB_SIZE].str, str);
	FONTLIB[LIB_SIZE].array_16 = array_16;
	FONTLIB[LIB_SIZE].array_32 = array_32;
	LIB_SIZE++;
}




unsigned char *search_font_array(unsigned char *str, int size)
{
	
	for(int i = 0; i < LIB_SIZE; i++)
	{
		
		if(strcmp(FONTLIB[i].str, str) == 0)
		{
			if(size == 16)
			{
				return FONTLIB[i].array_16;
			
			}
			else if(size == 32)
			{
				return FONTLIB[i].array_32;
			}
		}
	}

	printf("find no this %s in fontlib\n", str);
}







//
int Print(pLcdInfo_t plcdinfo, int x, int y, unsigned char *font_array, int width, int height, 
	 unsigned int color)
{
	
	//保存起始地址	
	unsigned int *base = plcdinfo->base + x + plcdinfo->width*y;

	//计算一行用多少位数据表示,仅支持 1位数据 代表 8个像素点格式
	int rowsize = width / 8;

	//每一次读取一行
	for(int rows = 0; rows < height*rowsize; rows = rows + rowsize)
	{

		int judge = 0x80;
		
		for(int cols = 0; cols < rowsize; cols++)
		{
			for(int i = 0; i < 8; i++)
			{
				if((font_array[rows + cols] & (judge >> i)))
				{
					//printf("1");
					*(base + i) = color; 
				}
				//else printf("0");
			}

			//前进八个像素点
			base = base + 8;
		}
		//printf("\n");

		//换行	
		base = base + plcdinfo->width - 8 * rowsize;
	}

}

